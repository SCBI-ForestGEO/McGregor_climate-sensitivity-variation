```{r include=FALSE, cache=FALSE}
rm(list = ls(all = TRUE))
```
# Results

## tree and trait distribution within the biophysical setting

**Figure 2. Vertical profiles in microclimate, crown positions, and traits.**[combines the two following figures]

![Climate variables with height](tables_figures/NEON_vertical_profiles.png){width=500px} 

![Leaf hydraulic traits with log-values of height](tables_figures/traits_vs_traits.png){width=500px}

[consider an analysis of trait distribution in relation to topography??]

## droughts(?)
[description of the 3 droughts in terms of timing, duration, severity, proportion of trees showing pointer year..?]

## [1- tree size and exposure]
We evaluated the predictions outlined in the introduction
P1.0. Drought resistance decreased with DBH at time of drought.
P1.1. Drought resistance decreased with height at time of drought.
P1.2. Trees currently in a dominant crown position suffered more during drought. Intermediate and suppressed trees also suffered more (in model with height)
P1.3. Resistance was independent of elevation and distance from stream.

[**HYPOTHESIS TESTING TABLE**]

## [2- traits]

``` {r, biophysical-model, eval=TRUE, echo=FALSE, message=FALSE, cache=TRUE}
library(lme4)
library(AICcmodavg) #aictab function
library(car)
library(data.table)
library(knitr)
library(kableExtra)

trees_all_bio <- read.csv("tables_figures/trees_all_bio.csv", stringsAsFactors = FALSE)

response <- "resist.value"
effects <- c("position_all", "elev.m", "distance.ln.m", "height.ln.m", "year", "(1|sp)")

#create all combinations of random / fixed effects
effects_comb <- 
  unlist( sapply( seq_len(length(effects)), 
                  function(i) {
                    apply( combn(effects,i), 2, function(x) paste(x, collapse = "+"))
                  }))

# pair response with effect and sub out combinations that don't include random effects
#in general, if two variables are >70% correlated, you can toss one of them without significantly affecting the results
var_comb <- expand.grid(response, effects_comb) 
var_comb <- var_comb[grepl("1", var_comb$Var2), ] #only keep in fixed/random combos
var_comb <- var_comb[grepl("year", var_comb$Var2), ] #keep year in for drought sake

# formulas for all combinations. $Var1 is the response, and $Var2 is the effect
# for good stats, you should have no more total parameters than 1/10th the number of observations in your dataset
formula_vec <- sprintf("%s ~ %s", var_comb$Var1, var_comb$Var2)

# create list of model outputs
lmm_all <- lapply(formula_vec, function(x){
  fit1 <- lmer(x, data = trees_all_bio, REML=FALSE, 
               control = lmerControl(optimizer ="Nelder_Mead"))
  return(fit1)
})
names(lmm_all) <- formula_vec

var_aic <- aictab(lmm_all, second.ord=TRUE, sort=TRUE) #rank based on AICc

best <- lmm_all[[8]]
cof_bio <- data.frame("value" = coef(summary(best))[ , "Estimate"])
cof_bio <- setDT(cof_bio, keep.rownames = TRUE)[]
setnames(cof_bio, old="rn", new="coefficients")

```
``` {r, full-model, eval=TRUE, echo=FALSE, message=FALSE, cache=TRUE}
trees_all_full <- read.csv("tables_figures/trees_all_full.csv", stringsAsFactors = FALSE)

response <- "resist.value"
effects <- c("rp", "PLA_dry_percent", "LMA_g_per_m2", "WD_g_per_cm3", "mean_TLP_Mpa", "height.ln.m", "position_all", "year", "(1|sp/tree)")

#create all combinations of random / fixed effects
effects_comb <- 
  unlist( sapply( seq_len(length(effects)), 
                  function(i) {
                    apply( combn(effects,i), 2, function(x) paste(x, collapse = "+"))
                  }))

# pair response with effect and sub out combinations that don't include random effects
#in general, if two variables are >70% correlated, you can toss one of them without significantly affecting the results
var_comb <- expand.grid(response, effects_comb) 
var_comb <- var_comb[grepl("1", var_comb$Var2), ] #only keep in fixed/random combos
var_comb <- var_comb[grepl("year", var_comb$Var2), ] #keep year in for drought sake

# formulas for all combinations. $Var1 is the response, and $Var2 is the effect
# for good stats, you should have no more total parameters than 1/10th the number of observations in your dataset
formula_vec <- sprintf("%s ~ %s", var_comb$Var1, var_comb$Var2)

# create list of model outputs
lmm_all <- lapply(formula_vec, function(x){
  fit1 <- lmer(x, data = trees_all_full, REML=FALSE, 
               control = lmerControl(optimizer ="Nelder_Mead"))
  return(fit1)
})
names(lmm_all) <- formula_vec

var_aic <- aictab(lmm_all, second.ord=TRUE, sort=TRUE) #rank based on AICc

best <- lmm_all[[121]]
cof_full <- data.frame("value" = coef(summary(best))[ , "Estimate"])
cof_full <- setDT(cof_full, keep.rownames = TRUE)[]
setnames(cof_full, old="rn", new="coefficients")
```
```{r, make-tables, eval=TRUE, echo=FALSE, message=FALSE, results = 'asis'}
library(knitr)
library(kableExtra)

cof_bio %>%
  kable("html", align = 'clc', caption = 'Biophysical Model') %>%
    kable_styling(full_width = F, position = "float_left")
 
cof_full %>%
  kable("html", align = 'clc', caption = 'Full Model') %>%
    kable_styling(full_width = F, position = "right")
```



