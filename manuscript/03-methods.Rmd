# Methods
## Study site
Research was conducted at the 25.6 ha ForestGEO (Global Earth Observatory) study plot at the Smithsonian Conservation Biology Institute (SCBI) in Virginia, USA (38°53'36.6"N, 78° 08'43.4"W) [@andersonteixeira_ctfs-forestgeo:_2015]. SCBI is located in the central Appalachian Mountains at the northern edge of Shenandoah National Park.  Elevations range from 273-338m above sea level [@gonzalezakre_patterns_2016] with a topographic relief of 65m [@bourg_initial_2013]. Dominant species include *Liriodendron tulipifera*,  oaks (*Quercus* spp.), and hickories (*Carya* spp.).

## Data collection and preparation
The SCBI ForestGEO plot was censused in 2008, 2013, and 2018 following standard ForestGEO protocols... [DETAILS]. Here, we use ...(*very brief summary of which data we use for what purpose-- but some will be better integrated with methods descriptions below*)

We analyzed tree-ring data from the twelve species contributing most to woody aboveground net primary productivity (ANPP_stem) (Table 1), which together comprised 97% of whole-ecosystem ANPP_stem between 2008 and 2013. Cores were collected in 2010-2011 or 2016-2017 from a breast height of 1.3m using a 5mm increment borer. In 2010-2011, cores were collected from randomly selected live trees were selected at random from each species in 2010-2011, with at least 30 of those trees having a diameter at breast height (DBH) of at least 10cm [@bourg_initial_2013]. In 2016-2017, cores were collected from all dead trees found in the annual mortality census [@gonzalezakre_patterns_2016]. Cores were sanded, measured, and cross-dated using standard procedures, as detailed in [@helcoski_growing_2019]. The resulting chronologies have been published in association with [@helcoski_growing_2019]: (GitHub URL), (ITRDB). 

Height measurements (n=# trees) were taken by several researchers between 2012 to 2019, and are archived in a public GitHub repository (*GitHUB URL*). Measurement methods included manual [@stovall_assessing_2018, NEON], digital rangefinders [@andersonteixeira_ctfs-forestgeo:_2015] (CITATION NOT APPROPRIATE), and automatic LiDAR [@stovall_terrestrial_2018]. Rangefinders either used the tangent method (Impulse 200LR, TruPulse 360R) or the sine method (Nikon ForestryPro) for calculating heights. The associated errors for using either method were acknowledged [@larjavaara_measuring_2013]. Species-specific height allometries were developed (Table S# - **ADD THIS TABLE TO SI**). For species that didn't have enough height measurements, heights were calculated from equations derived from all species in the study. 

For each tree, we combined tree-ring records and allometric equations of height and bark thickness to retroactively calculate DBH and estimate height for the years 1950-2009. Prior DBH was estimated using the following equation:

`diam_1999 = dbh2008 - 2*(bark.depth2008) - 2*(sum(ring.width1999:ring.width2008)) + 2*(bark.depth_1999)`  ([issue #35](https://github.com/SCBI-ForestGEO/McGregor_climate-sensitivity-variation/issues/35)) (**clean up this equation--put a generic year instead of 1999, use sum symbol, etc.**)

Here, *ring.width* was measured from cores. Bark thickness was estimated from species-specific allometries based on the bark thickness data of [@andersonteixeira_size-related_2015].
Specifically, we used linear regression equations on log-transformed data to relate bark thickness to DBH (Table S#- **create table to give these equations in SI**) and then used these to estimate bark thickness based on DBH. 

Crown positions were recorded in the field during the growing season of 2018 following the crown position protocol from [@jennings_assessing_1999], whereby positions were ranked as dominant, codominant, intermediate, or suppressed. As there was no way to retroactively estimate crown position, we assumed that 2018 crown position was reflective of each tree's position over the past 60 years. While some trees undoubtedly changed position, an analysis of canopy position relative to height (Fig. XX) and height change since *1959* indicated that change was likely slow. [**work on this-- provide details?**]

Elevation for the trees was extracted from a USGS DEM in ArcMap. Distance to water was calculated as the shortest distance in meters between each individual tree and the major streams running through the ForestGEO plot.

Hydraulic traits were collected from SCBI and are summarized in Table 1. In August 2018, we collected leaf samples from three individuals of each species ... (**Nobby's description of methods for the following**) 
1. PLA
2. LMA
4. Wood density
5. TLP
6. P50 = psi_0.5_kl50
7. P80 = psi_0.5_kl80 


**Table 1. Species analyzed here, listed in descending order of ANPP_stem. n cores and DBH range represented, and species traits** [*This replaces/combines the two remaining tables in this section. Suggested columns, with those to include only if they fit in parentheses: species, (stems >=10 cm per ha in plot), (ANPP_stem), n cores, DBH range of cores, (n cores in each canopy position) species means for each trait]


```{r, Table-cores-position, eval=TRUE, echo=FALSE, message=FALSE}
library(RCurl)
library(dplyr)
library(tidyr)
library(data.table)
library(knitr)
library(kableExtra)

species <- read.csv(text=getURL("https://raw.githubusercontent.com/SCBI-ForestGEO/McGregor_climate-sensitivity-variation/master/data/core_list_for_neil.csv?token=AJNRBEIAVYFAN2CJB3Y3UAS5D5BNG"), stringsAsFactors = FALSE)

table <- species[, c(1:3,6,17)]

positions <- read.csv(text=getURL("https://raw.githubusercontent.com/SCBI-ForestGEO/SCBI-ForestGEO-Data/master/tree_dimensions/tree_crowns/cored_dendroband_crown_position_data/dendro_cored_full.csv"))

table$position_all <- positions$crown.position[match(table$tag, positions$tag)]
table$position_all <- gsub("D", "dominant", table$position_all)
table$position_all <- gsub("C", "co-dominant", table$position_all)
table$position_all <- gsub("I", "intermediate", table$position_all)
table$position_all <- gsub("S", "suppressed", table$position_all)

table1 <- table %>%
  group_by(sp) %>%
  summarize(n_cores=n())

table2 <- table %>%
  group_by(sp, position_all) %>%
  summarize(count=n())

table2 <- spread(table2, key=position_all, value=count)
setnames(table2, old="<NA>", new="prior dead")

table2$n_cores <- table1$n_cores[match(table2$sp, table1$sp)]
table2 <- table2[, c(1,7,3,2,4:6)]
table2 <- table2[!table2$sp %in% c("frni", "pist"), ]

kable(table2) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```





```{r, traits-overview, eval=TRUE, echo=FALSE, message=FALSE}
library(knitr)
library(kableExtra)

trees_all <- read.csv("tables_figures/trees_all.csv", stringsAsFactors = FALSE)

trees_all <- trees_all[!duplicated(trees_all$sp), ]
  

traits_table <- data.frame(
  "Trait" = c("Ring Porosity", "Percent Leaf Area", "Leaf Mass Area", "Chlorophyll", "Wood density", "TLP", "P50", "P80"),
  "Unit" = c("ring, semi-ring, diffuse", "%", "g/m2", "m2/g", "g/cm3", "MPa", "MPa", "MPa"))
traits_table$abb <- c("rp", "PLA", "LMA", "Chl", "WD", "TLP", "p50", "p80")

traits_table$mean <- NA
traits_table$min <- NA
traits_table$max <- NA

for (i in seq(along=traits_table$abb[2:8])){
  trait <- traits_table$abb[2:8][i]
  
  sub <- trees_all[grepl(trait, colnames(trees_all))]
  traits_table$mean[2:8][i] <- ifelse(grepl(trait, colnames(sub)), 
                              mean(sub[, 1], na.rm=TRUE), 
                              traits_table$mean)
  
  traits_table$min[2:8][i] <- ifelse(grepl(trait, colnames(sub)), 
                              min(sub[, 1], na.rm=TRUE), 
                              traits_table$min)
  
  traits_table$max[2:8][i] <- ifelse(grepl(trait, colnames(sub)), 
                              max(sub[, 1], na.rm=TRUE), 
                              traits_table$max)
}

traits_table[, c("mean", "min", "max")] <- 
  sapply(traits_table[, c("mean", "min", "max")], function(x)
  round(x, 2)
)
traits_table$abb <- NULL

kable(traits_table) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

```

## Identification of drought years
To determine focus drought years, we used the pointRes package [@R-pointRes] in R (version 3.5.2) to determine resilience metrics. Specifically, we calculated pointer years (main drought years) if >50% of the cored trees experienced <30% growth in a year compared to the previous 5 years. The top 6 pointer years were compared with PDSI (Palmer Drought Severity Index) values for the region, obtained from NOAA. Based on this comparison, we then took the top three pointer years of 1964-1966 (resistance metric averaged due to a single, prolonged drought), 1977, and 1999. [**This needs work. It's very complex to describe what you did, and in retrospect not well-aligned with our current analysis. It would be much more straightforward to simply combine ALL cores in the pointRes package to identify potential pointer years. Is this a lot of work? In any case, we should find a way to present this analysis in one paragraph (no tables!) of main body text. If you need to stick with species/canopy position-level analysis, any tables and detailed description should go in SI**]

**Figure 1. Time series of peak growing season (May-August) climate conditions and residual chronologies for each species.** Droughts analyzed here are indicated by dashed lines, and shading indicates the pre-drought period used in calculations of the resistance metric.
![Time series of combined tree cores by species](tables_figures/Time_series_for_each_species.jpg){width=500px}

## Analysis
After the data was collected, linear mixed models were run with the resistance value of each tree for each pointer year (determined from the pointRes package) as the response variable. Traits and other geographic data were used as independent variables.

Traits' importance in predicting drought tolerance was calculated from mixed-effects models and the lowest AICc [@R-lme4, @R-AICcmodavg]. Specifically, we first determined the most important biophysical traits before including them in the model with the leaf hydraulic traits [**need to say why?**]